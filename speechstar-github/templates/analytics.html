{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar me-2"></i>
            Аналитика
        </h1>
    </div>
</div>

<!-- Engagement Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Показатели вовлеченности
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="h2 text-primary">{{ engagement_stats.get('total_users', 0) }}</div>
                        <div class="text-muted">Всего пользователей</div>
                    </div>
                    <div class="col-md-3">
                        <div class="h2 text-success">{{ engagement_stats.get('active_users', 0) }}</div>
                        <div class="text-muted">Активные пользователи</div>
                    </div>
                    <div class="col-md-3">
                        <div class="h2 text-warning">{{ engagement_stats.get('trial_users', 0) }}</div>
                        <div class="text-muted">На пробном периоде</div>
                    </div>
                    <div class="col-md-3">
                        <div class="h2 text-info">{{ engagement_stats.get('subscribed_users', 0) }}</div>
                        <div class="text-muted">Подписчики</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Popular Tasks -->
{% if popular_tasks %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-fire me-2"></i>
                    Популярные задания
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Задание</th>
                                <th>Возрастная группа</th>
                                <th>Выполнений</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in popular_tasks[:10] %}
                            <tr>
                                <td>
                                    <strong>{{ task.get('title', 'Без названия') }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ task.get('age_group', '') }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ task.get('completion_count', 0) }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Telegram Export -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fab fa-telegram me-2"></i>
                    Экспорт аналитики в Telegram
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Ручной экспорт</h6>
                        <p class="text-muted">Отправить текущую аналитику в Telegram канал</p>
                        <div class="d-grid gap-2">
                            <form method="POST" action="{{ url_for('export_analytics_telegram') }}" class="d-inline">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fab fa-telegram me-2"></i>
                                    Ежедневный отчет
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('export_weekly_analytics') }}" class="d-inline">
                                <button type="submit" class="btn btn-info w-100">
                                    <i class="fas fa-calendar-week me-2"></i>
                                    Еженедельный отчет
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Автоматический экспорт</h6>
                        <p class="text-muted">Настройка регулярной отправки отчетов</p>
                        <form method="POST" action="{{ url_for('schedule_analytics_export') }}">
                            <div class="mb-3">
                                <label class="form-label">Ежедневный отчет</label>
                                <input type="time" class="form-control" name="export_time" value="09:00">
                                <small class="form-text text-muted">Время отправки каждый день</small>
                            </div>
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">Еженедельный отчет</label>
                                    <select class="form-select" name="weekly_day">
                                        <option value="monday">Понедельник</option>
                                        <option value="tuesday">Вторник</option>
                                        <option value="wednesday">Среда</option>
                                        <option value="thursday">Четверг</option>
                                        <option value="friday">Пятница</option>
                                        <option value="saturday">Суббота</option>
                                        <option value="sunday">Воскресенье</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Время</label>
                                    <input type="time" class="form-control" name="weekly_time" value="10:00">
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="export_enabled" id="exportEnabled">
                                <label class="form-check-label" for="exportEnabled">
                                    Включить автоматический экспорт
                                </label>
                            </div>
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-clock me-2"></i>
                                Сохранить настройки
                            </button>
                            
                        </form>
                        
                        <!-- Статус планировщика -->
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-info" onclick="checkSchedulerStatus()">
                                <i class="fas fa-info-circle me-1"></i>
                                Проверить статус
                            </button>
                            <div id="schedulerStatus" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Age Group Distribution -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Распределение по возрастным группам
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Статистика пользователей:</h6>
                        <div class="progress-stacked mb-2">
                            <div class="progress" style="width: 20%">
                                <div class="progress-bar bg-primary" style="width: 100%">8-12 мес</div>
                            </div>
                            <div class="progress" style="width: 20%">
                                <div class="progress-bar bg-success" style="width: 100%">12-15 мес</div>
                            </div>
                            <div class="progress" style="width: 20%">
                                <div class="progress-bar bg-warning" style="width: 100%">15-18 мес</div>
                            </div>
                            <div class="progress" style="width: 20%">
                                <div class="progress-bar bg-info" style="width: 100%">18-24 мес</div>
                            </div>
                            <div class="progress" style="width: 20%">
                                <div class="progress-bar bg-secondary" style="width: 100%">2-3 года</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Конверсия в подписку:</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h4 text-success">
                                        {% if engagement_stats.get('total_users', 0) > 0 %}
                                        {{ ((engagement_stats.get('subscribed_users', 0) / engagement_stats.get('total_users', 1)) * 100)|round(1) }}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">Конверсия</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h4 text-warning">
                                        {% if engagement_stats.get('total_users', 0) > 0 %}
                                        {{ ((engagement_stats.get('trial_users', 0) / engagement_stats.get('total_users', 1)) * 100)|round(1) }}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">На пробном</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function checkSchedulerStatus() {
    try {
        const response = await fetch('/analytics/scheduler-status');
        const status = await response.json();
        
        const statusDiv = document.getElementById('schedulerStatus');
        
        if (status.running) {
            let nextRuns = '';
            if (status.next_runs && status.next_runs.length > 0) {
                nextRuns = '<ul class="mb-0">';
                status.next_runs.forEach(run => {
                    nextRuns += `<li><small>${run.job}: ${run.next_run}</small></li>`;
                });
                nextRuns += '</ul>';
            }
            
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-sm">
                    <i class="fas fa-check-circle me-1"></i>
                    Планировщик активен
                    ${nextRuns}
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-pause-circle me-1"></i>
                    Планировщик неактивен
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('schedulerStatus').innerHTML = `
            <div class="alert alert-danger alert-sm">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Ошибка проверки статуса
            </div>
        `;
    }
}
</script>

{% endblock %}